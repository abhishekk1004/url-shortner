{% extends "base.html" %}
{% block content %}

<h2>QR Code for Short URL</h2>

<div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
    <div style="margin-bottom: 15px;">
        <strong>Short URL:</strong> 
        <a href="{{ short_url }}" target="_blank" rel="noopener noreferrer" style="color: #007bff;">{{ short_url }}</a>    </div>
    
    <div style="margin-bottom: 15px;">
        <strong>Original URL:</strong> 
        <span style="word-break: break-all;">{{ url.original_url }}</span>
    </div>
    
    <div style="margin-bottom: 15px;">
        <strong>Clicks:</strong> {{ url.clicks }}
    </div>
    
    <div style="margin-bottom: 15px;">
        <strong>Created:</strong> {{ url.created_at|date:"M d, Y H:i" }}
    </div>
</div>

<div style="text-align: center; background-color: white; padding: 30px; border: 2px solid #dee2e6; border-radius: 8px; margin: 20px 0;">
    <h3 style="margin-top: 0;">Scan to Visit</h3>
    <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" style="max-width: 400px; width: 100%;" id="qrCodeImage">
</div>

<div style="margin-top: 20px; text-align: center;">
    <a href="{% url 'download_qr' url.id %}" 
       style="padding: 12px 24px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px;"
       download>
        üì• Download QR Code
    </a>
    
    <button onclick="shareQRCode()" 
            style="padding: 12px 24px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">
        üì§ Share QR Code
    </button>
    
    <button onclick="copyShortURL()" 
            style="padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;">
        üìã Copy Short URL
    </button>
    
    <a href="{% url 'dashboard' %}" 
       style="padding: 12px 24px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px;">
        ‚Üê Back to Dashboard
    </a>
</div>

<script>
function copyShortURL() {
    const url = "{{ short_url|escapejs }}";
    navigator.clipboard.writeText(url).then(function() {
        alert('Short URL copied to clipboard!');
    }, function(err) {
        console.error('Could not copy text: ', err);
    });
}

async function shareQRCode() {
    // Check if Web Share API is available
    if (navigator.share) {
        try {
            // Convert base64 to blob
            const base64Data = "{{ qr_code|escapejs }}";
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], {type: 'image/png'});
            const file = new File([blob], 'qr_code_{{ url.short_key|escapejs }}.png', {type: 'image/png'});
            
            await navigator.share({
                title: 'QR Code for Short URL',
                text: 'Scan this QR code to visit: {{ short_url }}',
                files: [file]
            });
        } catch (err) {
            // If sharing fails, copy URL instead
            const url = "{{ short_url|escapejs }}";
            navigator.clipboard.writeText(url).then(function() {
                alert('Sharing failed. Short URL copied to clipboard instead!');
            }, function(copyErr) {
                alert('Sharing failed and could not copy to clipboard.');
                console.error('Could not copy text: ', copyErr);
            });
        }
    } else {
        // Fallback: copy URL to clipboard
        copyShortURL();
        alert('Sharing not available on this device. Short URL copied to clipboard!');
    }
}

// Right-click save image functionality
document.getElementById('qrCodeImage').addEventListener('contextmenu', function(e) {
    // Allow default behavior for saving image
});
</script>

<style>
    @media print {
        button, a[href="{% url 'dashboard' %}"] {
            display: none;
        }
    }
</style>

{% endblock %}
